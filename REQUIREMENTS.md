# 要件定義書 (Requirements Definition)

## 1. システム概要
本システム「MailConsolidator」は、複数のメールアカウント（POP3/IMAP）からメールを取得し、単一のIMAPサーバへ集約・転送するデスクトップアプリケーションである。

## 2. 機能要件

### 2.1 メール集約機能
- **複数ソース対応**: 複数の取得元メールサーバ（POP3およびIMAP）を設定可能とする。
- **転送先設定**: 単一の転送先IMAPサーバを設定可能とする。
- **プロトコル対応**:
  - 取得元: POP3 (SSL), IMAP (SSL)
  - 転送先: IMAP (SSL)
- **メール取得ロジック**:
  - **IMAP**: 「未読」メールのみを取得対象とする。
  - **POP3**: 新着メールを取得対象とする（サーバ仕様に依存）。

### 2.2 メール処理・保持ポリシー
- **移動後に削除 (Delete after move)**:
  - 設定により、転送成功後に取得元サーバからメールを削除可能とする（POP3推奨）。
  - 削除しない設定の場合（IMAP推奨）、取得元サーバで「既読」マークを付与し、次回取得対象外とする。
  - 削除しない設定の場合、GUIのステータスモニターには「完了（保持）」として履歴を残す。

### 2.3 ユーザーインターフェース (GUI)
- **設定画面**:
  - 転送先サーバの設定（ホスト、ポート、ユーザー、パスワード、フォルダ）。
  - 取得元サーバの追加・編集・削除。
  - **設定更新**: 既存の取得元設定を選択して内容を更新できること（リスト選択状態の維持）。
- **実行パネル**:
  - **手動実行**: 「今すぐ実行」ボタンにより、即座に集約処理を実行可能とする。
  - **定期実行**:
    - 指定した間隔（分）でバックグラウンドで集約処理を実行可能とする。
    - **設定保存**: 実行間隔の変更は、入力フィールドからフォーカスが外れた時点で自動的に設定ファイルに保存されること。
    - 「定期実行を開始/停止」ボタンにより、処理のON/OFFを切り替え可能とする。
    - 実行中はボタン名を「定期実行を停止」に変更し、停止操作を受け付けること。
    - 停止処理中は「停止処理中...」等のフィードバックを表示すること。
  - **ステータスモニター**:
    - 処理中のメール（送信者、件名、日時、ステータス）をリアルタイムで一覧表示する。
  - **終了ボタン**: 操作パネルの右端に「アプリを終了」ボタンを配置し、アプリケーションを完全に終了できること。

### 2.4 Windows システムトレイ機能
- **トレイアイコン**: Windows環境では、システムトレイにアイコンを表示する。
- **トレイメニュー**:
  - ウィンドウの表示/非表示を切り替え
  - 定期実行のON/OFFを切り替え
  - アプリケーションの終了
- **閉じるボタンの動作**: ウィンドウの閉じるボタン（×）を押した場合、ダイアログを表示し、以下から選択可能とする：
  - **アプリを終了**: アプリケーションを完全に終了
  - **バックグラウンド常駐**: ウィンドウを非表示にしてトレイに格納
  - **キャンセル**: 操作を取り消す

### 2.5 単一インスタンス制御
- **インスタンス検出**: 起動時に既存のプロセスが実行中かをPIDファイルで確認する。
- **IPC通信**: 既存インスタンスが存在する場合、ソケット通信（IPC）でGUI表示コマンドを送信する。
- **GUI表示**: 既存インスタンスがコマンドを受信すると、ウィンドウを前面に表示する。
- **タスク継続**: 既存インスタンスのバックグラウンドタスク（定期実行など）は中断されない。
- **新規起動の抑制**: 既存インスタンスとの通信に成功した場合、新しいプロセスは起動せずに終了する。

### 2.6 起動モード
- **デフォルト起動**: オプションなしで起動した場合、GUIをバックグラウンドで起動し、プロンプトが即座に戻る。既存インスタンスがある場合は、そのGUIを表示する。
- **フォアグラウンドGUI**: `-v` オプションで起動した場合、GUIをフォアグラウンドで起動し、詳細ログをコンソールに表示する。
- **デーモンモード**: `-d` オプションで起動した場合、GUIなしでバックグラウンド実行する。
- **デーモン停止**: `-k` オプションで、実行中のバックグラウンドプロセスを停止可能とする。

### 2.7 デーモン管理機能
- **バックグラウンド実行**: コマンドライン引数 `-d` により、GUIなしでバックグラウンドプロセスとして起動可能とする。
- **デーモン停止**: コマンドライン引数 `-k` により、実行中のバックグラウンドプロセスを停止可能とする。
- **プロセス追跡**: PIDファイルを使用してバックグラウンドプロセスを追跡・管理する。
- **安全な終了**: デーモン停止時は、まず正常終了シグナル（SIGTERM）を送信し、応答がない場合は強制終了（SIGKILL）を行う。

### 2.7 セキュリティ
- **通信暗号化**: すべてのメールサーバ通信においてSSL/TLSをサポートする。
- **パスワード管理**:
  - 設定ファイル (`config.yaml`) 内のパスワードは暗号化して保存する。
  - Gmail等のアプリパスワードに対応する（OAuth 2.0は非採用）。

## 3. 非機能要件

### 3.1 操作性・応答性
- **バックグラウンド実行**: 定期実行および手動実行はメインスレッド（UIスレッド）とは別のスレッドで実行し、GUIのフリーズ（「応答なし」）を防止する。
- **フィードバック**: 処理の開始・終了・エラー発生時に適切なメッセージまたはログを表示する。

### 3.2 信頼性
- **データ保全**: 転送先への保存が完了したことを確認してから、取得元の削除または既読化を行う（メール消失の防止）。
- **エラーハンドリング**: ネットワークエラーや認証エラーが発生してもアプリケーションがクラッシュせず、エラーログを記録して次回の実行に備える。

### 3.3 環境
- **OS**: Windows (主なターゲット), Unix系OSもサポート
  - ※システムトレイ機能はWindowsのみサポート
- **言語**: Python 3.x
- **ライブラリ**: Tkinter (GUI), imaplib, poplib, PyYAML, cryptography, psutil, pystray, Pillow, certifi
- **開発ツール**: PyInstaller (exe化用)
## 5. 配布方法
- **Windows**: Inno Setup を使用したインストーラーを提供
  - PyInstaller で one-folder 形式の実行ファイルを生成
  - Inno Setup でインストーラーを作成
  - ユーザーはインストーラーを実行するだけで簡単にインストール可能
- **その他のOS**: Python スクリプトとして配布
